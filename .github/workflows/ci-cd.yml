name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

env:
  TF_VERSION: "1.5.7"
  ANSIBLE_VERSION: "2.15.0"
  PYTHON_VERSION: "3.11"

jobs:
  # Code Quality and Validation
  quality-check:
    name: Code Quality & Validation
    runs-on: ubuntu-latest
    outputs:
      terraform-format: ${{ steps.terraform-format.outcome }}
      ansible-lint: ${{ steps.ansible-lint.outcome }}
      security-scan: ${{ steps.security-scan.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install ansible-lint
          pip install tfsec
          pip install checkov

      - name: Terraform Format Check
        id: terraform-format
        run: |
          echo "Checking Terraform format..."
          cd terraform
          terraform fmt -check -recursive
          echo "Terraform format check passed"

      - name: Terraform Validation
        run: |
          echo "Validating Terraform configurations..."
          ./tests/terraform/validate.sh

      - name: Security Scanning
        id: security-scan
        run: |
          echo "Running security scans..."
          ./tests/terraform/security-scan.sh

      - name: Ansible Syntax Check
        run: |
          echo "Checking Ansible syntax..."
          ./tests/ansible/syntax-check.sh

      - name: Ansible Linting
        id: ansible-lint
        run: |
          echo "Running Ansible linting..."
          ./tests/ansible/lint.sh

      - name: Upload Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports
          path: |
            reports/
            logs/
          retention-days: 30

  # LocalStack Testing
  localstack-test:
    name: LocalStack Integration Tests
    runs-on: ubuntu-latest
    needs: quality-check
    if: needs.quality-check.outputs.terraform-format == 'success' && needs.quality-check.outputs.ansible-lint == 'success'

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
          - 4571:4571
        env:
          SERVICES: s3,ec2,iam,cloudwatch,logs,ssm,secretsmanager
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
        volumes:
          - /tmp/localstack:/tmp/localstack
          - ./docker/localstack-data:/etc/localstack/init

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install awscli
          pip install localstack

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:4566/health; do sleep 2; done'

      - name: Deploy to LocalStack
        run: |
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=us-east-1
          export AWS_ENDPOINT_URL=http://localhost:4566

          cd terraform/localstack
          terraform init
          terraform apply -auto-approve -var="create_aws_resources=true"

      - name: Run Integration Tests
        run: |
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=us-east-1
          export AWS_ENDPOINT_URL=http://localhost:4566

          ./tests/integration/smoke-test.sh

      - name: Run Security Tests
        run: |
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=us-east-1
          export AWS_ENDPOINT_URL=http://localhost:4566

          ./tests/security/compliance-test.sh

      - name: Cleanup LocalStack
        if: always()
        run: |
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=us-east-1
          export AWS_ENDPOINT_URL=http://localhost:4566

          cd terraform/localstack
          terraform destroy -auto-approve

  # AWS Staging Deployment (Optional)
  aws-staging:
    name: AWS Staging Deployment
    runs-on: ubuntu-latest
    needs: [quality-check, localstack-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to Staging
        run: |
          ./scripts/deploy-demo.sh \
            --project infra-staging \
            --ssh-key staging-key \
            --alarm-email ${{ secrets.ALARM_EMAIL }} \
            --budget 50

      - name: Run Staging Tests
        run: |
          ./tests/integration/smoke-test.sh --environment staging

      - name: Cost Report
        run: |
          ./scripts/cost-check.sh --project infra-staging

      - name: Cleanup Staging
        if: always()
        run: |
          ./scripts/cleanup-demo.sh --project infra-staging

  # Production Deployment (Manual)
  production-deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    needs: [quality-check, localstack-test, aws-staging]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Production Deployment
        run: |
          echo "Deploying to production..."
          ./scripts/deploy-demo.sh \
            --project infra-production \
            --ssh-key production-key \
            --alarm-email ${{ secrets.ALARM_EMAIL }} \
            --budget 200 \
            --production

      - name: Production Health Check
        run: |
          echo "Running production health checks..."
          ./tests/integration/smoke-test.sh --environment production

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [quality-check, localstack-test, aws-staging]
    if: always()

    steps:
      - name: Notify Success
        if: needs.quality-check.result == 'success' && needs.localstack-test.result == 'success'
        run: |
          echo "✅ CI/CD Pipeline completed successfully!"
          echo "All quality checks passed"
          echo "Integration tests passed"

      - name: Notify Failure
        if: needs.quality-check.result == 'failure' || needs.localstack-test.result == 'failure'
        run: |
          echo "❌ CI/CD Pipeline failed!"
          echo "Check the job logs for details"
          exit 1
