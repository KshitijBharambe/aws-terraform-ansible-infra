#!/bin/bash
# Web Server Monitoring Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Configuration
WEBSERVER_TYPE="{{ webserver_type | default('nginx') }}"
WEB_PORT="{{ webserver_port | default('80') }}"
SSL_PORT="{{ webserver_ssl_port | default('443') }}"
LOG_FILE="/var/log/webserver-monitor.log"
METRICS_FILE="/var/log/webserver-metrics.log"
ALERT_EMAIL="{{ webserver_monitor_alert_email | default('admin@' + ansible_domain) }}"
CPU_THRESHOLD="{{ webserver_cpu_threshold | default('80') }}"
MEMORY_THRESHOLD="{{ webserver_memory_threshold | default('80') }}"
DISK_THRESHOLD="{{ webserver_disk_threshold | default('80') }}"
RESPONSE_TIME_THRESHOLD="{{ webserver_response_threshold | default('5') }}"

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to log metrics
log_metric() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'),$1" >> "$METRICS_FILE"
}

# Function to send alert
send_alert() {
    local subject="$1"
    local message="$2"
    
    if command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "$subject" "$ALERT_EMAIL"
        log_message "Alert sent: $subject"
    else
        log_message "Mail command not found. Alert: $subject - $message"
    fi
}

# Function to check CPU usage
check_cpu() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    cpu_usage=${cpu_usage%.*}  # Get integer part
    
    log_metric "cpu_usage,$cpu_usage"
    
    if [ "$cpu_usage" -gt "$CPU_THRESHOLD" ]; then
        local message="High CPU usage detected: ${cpu_usage}% on {{ ansible_hostname }}"
        log_message "WARNING: $message"
        send_alert "Web Server CPU Alert" "$message"
        return 1
    fi
    
    return 0
}

# Function to check memory usage
check_memory() {
    local memory_usage=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    
    log_metric "memory_usage,$memory_usage"
    
    if [ "$memory_usage" -gt "$MEMORY_THRESHOLD" ]; then
        local message="High memory usage detected: ${memory_usage}% on {{ ansible_hostname }}"
        log_message "WARNING: $message"
        send_alert "Web Server Memory Alert" "$message"
        return 1
    fi
    
    return 0
}

# Function to check disk usage
check_disk() {
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    
    log_metric "disk_usage,$disk_usage"
    
    if [ "$disk_usage" -gt "$DISK_THRESHOLD" ]; then
        local message="High disk usage detected: ${disk_usage}% on {{ ansible_hostname }}"
        log_message "WARNING: $message"
        send_alert "Web Server Disk Alert" "$message"
        return 1
    fi
    
    return 0
}

# Function to check webserver process
check_webserver_process() {
    local process_count=$(pgrep -x "$WEBSERVER_TYPE" | wc -l)
    
    log_metric "process_count,$process_count"
    
    if [ "$process_count" -eq 0 ]; then
        local message="Web server process not running: $WEBSERVER_TYPE on {{ ansible_hostname }}"
        log_message "CRITICAL: $message"
        send_alert "Web Server Process Alert" "$message"
        
        # Attempt to restart the webserver
        systemctl start "$WEBSERVER_TYPE"
        sleep 3
        
        if systemctl is-active --quiet "$WEBSERVER_TYPE"; then
            log_message "Web server restarted successfully"
        else
            log_message "Failed to restart web server"
        fi
        
        return 1
    fi
    
    return 0
}

# Function to check response time
check_response_time() {
    local start_time=$(date +%s.%N)
    local response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "http://localhost:${WEB_PORT}/" 2>/dev/null)
    local end_time=$(date +%s.%N)
    local response_time=$(echo "$end_time - $start_time" | bc 2>/dev/null || echo "0")
    
    # Convert to milliseconds
    response_time=$(echo "$response_time * 1000" | bc 2>/dev/null || echo "0")
    response_time=${response_time%.*}  # Get integer part
    
    log_metric "response_time,$response_time"
    log_metric "http_status,$response"
    
    if [ "$response" != "200" ] && [ "$response" != "404" ]; then
        local message="Web server returned HTTP $response on {{ ansible_hostname }}"
        log_message "WARNING: $message"
        return 1
    fi
    
    if [ "$response_time" -gt "$RESPONSE_TIME_THRESHOLD" ]; then
        local message="Slow response time detected: ${response_time}ms on {{ ansible_hostname }}"
        log_message "WARNING: $message"
        return 1
    fi
    
    return 0
}

# Function to check SSL certificate expiration
check_ssl_cert() {
    if [ "{{ webserver_ssl_enabled | default(false) }}" = "true" ]; then
        local cert_file="{{ nginx_ssl_certificate | default('/etc/ssl/certs/nginx.crt') }}"
        if [ ! -f "$cert_file" ]; then
            cert_file="{{ apache_ssl_certificate | default('/etc/ssl/certs/apache.crt') }}"
        fi
        
        if [ -f "$cert_file" ]; then
            local expiry_date=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
            local expiry_epoch=$(date -d "$expiry_date" +%s 2>/dev/null || date -j -f "%b %d %H:%M:%S %Y %Z" "$expiry_date" +%s 2>/dev/null)
            local current_epoch=$(date +%s)
            local days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))
            
            log_metric "ssl_days_until_expiry,$days_until_expiry"
            
            if [ "$days_until_expiry" -lt 30 ]; then
                local message="SSL certificate expires in $days_until_expiry days on {{ ansible_hostname }}"
                log_message "WARNING: $message"
                send_alert "SSL Certificate Expiration Alert" "$message"
                return 1
            fi
        fi
    fi
    
    return 0
}

# Function to check log file sizes
check_log_sizes() {
    local log_dir="/var/log/$WEBSERVER_TYPE"
    
    if [ -d "$log_dir" ]; then
        local total_log_size=$(du -sb "$log_dir" 2>/dev/null | cut -f1)
        total_log_size=$((total_log_size / 1024 / 1024))  # Convert to MB
        
        log_metric "log_size_mb,$total_log_size"
        
        if [ "$total_log_size" -gt 1000 ]; then  # 1GB threshold
            local message="Large log files detected: ${total_log_size}MB in $log_dir on {{ ansible_hostname }}"
            log_message "WARNING: $message"
            return 1
        fi
    fi
    
    return 0
}

# Main monitoring function
main() {
    local exit_code=0
    
    log_message "Starting web server monitoring for $WEBSERVER_TYPE"
    
    # Run all checks
    check_cpu || exit_code=1
    check_memory || exit_code=1
    check_disk || exit_code=1
    check_webserver_process || exit_code=1
    check_response_time || exit_code=1
    check_ssl_cert || exit_code=1
    check_log_sizes || exit_code=1
    
    # Log overall status
    if [ $exit_code -eq 0 ]; then
        log_message "All monitoring checks passed"
    else
        log_message "Some monitoring checks failed"
    fi
    
    return $exit_code
}

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$METRICS_FILE")"

# Run main function
main "$@"
