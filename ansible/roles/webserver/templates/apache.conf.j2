# Apache Configuration File
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

ServerRoot "/etc/httpd"
PidFile "/var/run/httpd/httpd.pid"

# Load modules
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule mpm_worker_module modules/mod_mpm_worker.so
LoadModule headers_module modules/mod_headers.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule filter_module modules/mod_filter.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule log_config_module modules/mod_log_config.so

# Basic server settings
ServerAdmin {{ apache_server_admin | default('webmaster@' + ansible_domain) }}
ServerName {{ ansible_hostname }}
ServerSignature {{ apache_server_signature | default('Off') }}
ServerTokens {{ apache_server_tokens | default('Prod') }}

# Logging
ErrorLog "/var/log/httpd/error_log"
LogLevel {{ apache_log_level | default('warn') }}

# MIME settings
TypesConfig /etc/mime.types
AddType application/x-compress .gz
AddType text/html .shtml

# MPM settings
{% if apache_mpm_module == 'prefork' %}
<IfModule mpm_prefork_module>
    StartServers {{ apache_start_servers | default('2') }}
    MinSpareServers {{ apache_min_spare_servers | default('2') }}
    MaxSpareServers {{ apache_max_spare_servers | default('5') }}
    MaxRequestWorkers {{ apache_max_request_workers | default('150') }}
    MaxConnectionsPerChild {{ apache_max_connections_per_child | default('50') }}
</IfModule>
{% elif apache_mpm_module == 'worker' %}
<IfModule mpm_worker_module>
    ServerLimit {{ apache_server_limit | default('16') }}
    ThreadLimit {{ apache_thread_limit | default('25') }}
    ThreadsPerChild {{ apache_threads_per_child | default('25') }}
    MaxRequestWorkers {{ apache_max_request_workers | default('400') }}
    MaxMemFree {{ apache_max_mem_free | default('50') }}
</IfModule>
{% elif apache_mpm_module == 'event' %}
<IfModule mpm_event_module>
    ServerLimit {{ apache_server_limit | default('16') }}
    ThreadLimit {{ apache_thread_limit | default('25') }}
    ThreadsPerChild {{ apache_threads_per_child | default('25') }}
    MaxRequestWorkers {{ apache_max_request_workers | default('400') }}
</IfModule>
{% endif %}

# Performance settings
Timeout {{ apache_timeout | default('300') }}
KeepAlive {{ apache_keepalive | default('On') }}
MaxKeepAliveRequests {{ apache_max_keepalive_requests | default('100') }}
KeepAliveTimeout {{ apache_keepalive_timeout | default('5') }}

# Compression settings
<Location />
    SetOutputFilter DEFLATE
    SetEnvIfNoCase Request_URI \
        "\.(gif|jpe?g|png|avi|mov|wmv|mp3|mp4|ico|css|js)$" \
        no-gzip
</Location>

# Security settings
ServerTokens {{ apache_server_tokens | default('Prod') }}
TraceEnable {{ apache_trace_enable | default('Off') }}

# Security headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';"
</IfModule>

# Include virtual host configurations
IncludeOptional conf.d/*.conf
