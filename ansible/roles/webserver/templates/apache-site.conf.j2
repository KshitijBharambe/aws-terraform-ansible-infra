# Virtual Host Configuration for Apache
# Generated by Ansible for {{ ansible_hostname }}
# Domain: {{ site_domain | default(ansible_hostname) }}
# Environment: {{ ansible_environment }}

<VirtualHost *:80>
    ServerName {{ site_domain | default(ansible_hostname) }}
    ServerAlias www.{{ site_domain | default(ansible_hostname) }}
    DocumentRoot {{ apache_document_root | default('/var/www/html') }}
    DirectoryIndex {{ apache_index_files | default('index.html index.htm index.php') }}

    # Logging
    ErrorLog "/var/log/httpd/{{ site_domain | default(ansible_hostname) }}_error_log"
    CustomLog "/var/log/httpd/{{ site_domain | default(ansible_hostname) }}_access_log" combined

    # Directory permissions
    <Directory {{ apache_document_root | default('/var/www/html') }}>
        Options -Indexes +FollowSymLinks
        AllowOverride {{ apache_allow_override | default('All') }}
        Require all granted
    </Directory>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # PHP configuration (if enabled)
    {% if apache_enable_php | default(false) %}
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>

    <IfModule mod_php.c>
        php_value upload_max_filesize {{ apache_php_upload_max | default('64M') }}
        php_value post_max_size {{ apache_php_post_max | default('64M') }}
        php_value memory_limit {{ apache_php_memory_limit | default('256M') }}
        php_value max_execution_time {{ apache_php_max_execution_time | default('30') }}
    </IfModule>
    {% endif %}

    # Alias for health check
    Alias /health {{ apache_document_root | default('/var/www/html') }}/health

    <Location "/health">
        SetHandler server-status
    </Location>

    # Error pages
    ErrorDocument 404 /404.html
    ErrorDocument 500 /500.html
    ErrorDocument 502 /502.html
    ErrorDocument 503 /503.html
</VirtualHost>

# SSL Configuration (if enabled)
{% if apache_enable_ssl | default(false) %}
<VirtualHost *:443>
    ServerName {{ site_domain | default(ansible_hostname) }}
    ServerAlias www.{{ site_domain | default(ansible_hostname) }}
    DocumentRoot {{ apache_document_root | default('/var/www/html') }}
    DirectoryIndex {{ apache_index_files | default('index.html index.htm index.php') }}

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ apache_ssl_certificate | default('/etc/ssl/certs/apache.crt') }}
    SSLCertificateKeyFile {{ apache_ssl_certificate_key | default('/etc/ssl/private/apache.key') }}
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on

    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Security headers (repeated for SSL vhost)
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Redirect HTTP to HTTPS
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    </IfModule>

    # Include same directory and PHP settings as HTTP vhost
    <Directory {{ apache_document_root | default('/var/www/html') }}>
        Options -Indexes +FollowSymLinks
        AllowOverride {{ apache_allow_override | default('All') }}
        Require all granted
    </Directory>

    {% if apache_enable_php | default(false) %}
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>

    <IfModule mod_php.c>
        php_value upload_max_filesize {{ apache_php_upload_max | default('64M') }}
        php_value post_max_size {{ apache_php_post_max | default('64M') }}
        php_value memory_limit {{ apache_php_memory_limit | default('256M') }}
        php_value max_execution_time {{ apache_php_max_execution_time | default('30') }}
    </IfModule>
    {% endif %}

    # Logging for SSL vhost
    ErrorLog "/var/log/httpd/{{ site_domain | default(ansible_hostname) }}_ssl_error_log"
    CustomLog "/var/log/httpd/{{ site_domain | default(ansible_hostname) }}_ssl_access_log" combined
</VirtualHost>
{% endif %}
