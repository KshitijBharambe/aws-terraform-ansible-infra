# Logrotate configuration for {{ webserver_type | default('nginx') }}
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

{% if webserver_type == 'nginx' %}
# Nginx log rotation
/var/log/nginx/*.log {
    daily
    missingok
    rotate {{ webserver_logrotate_rotate | default('30') }}
    compress
    delaycompress
    notifempty
    create 644 nginx nginx
    sharedscripts
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# Nginx site-specific logs
/var/log/nginx/*_access.log /var/log/nginx/*_error.log {
    daily
    missingok
    rotate {{ webserver_logrotate_rotate | default('30') }}
    compress
    delaycompress
    notifempty
    create 644 nginx nginx
    sharedscripts
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

{% elif webserver_type == 'apache' %}
# Apache log rotation
/var/log/httpd/*.log {
    daily
    missingok
    rotate {{ webserver_logrotate_rotate | default('30') }}
    compress
    delaycompress
    notifempty
    create 644 apache apache
    sharedscripts
    postrotate
        /bin/systemctl reload httpd > /dev/null 2>&1 || true
    endscript
}

# Apache site-specific logs
/var/log/httpd/*_access_log /var/log/httpd/*_error_log /var/log/httpd/*_ssl_access_log /var/log/httpd/*_ssl_error_log {
    daily
    missingok
    rotate {{ webserver_logrotate_rotate | default('30') }}
    compress
    delaycompress
    notifempty
    create 644 apache apache
    sharedscripts
    postrotate
        /bin/systemctl reload httpd > /dev/null 2>&1 || true
    endscript
}

{% endif %}

# Webserver health check logs
/var/log/webserver-health-check.log {
    daily
    missingok
    rotate {{ webserver_logrotate_health_rotate | default('7') }}
    compress
    delaycompress
    notifempty
    create 644 root root
    size {{ webserver_logrotate_health_size | default('10M') }}
}

# Custom application logs (if specified)
{% if webserver_custom_logs | default([]) | length > 0 %}
{% for log_path in webserver_custom_logs %}
{{ log_path }} {
    daily
    missingok
    rotate {{ webserver_logrotate_custom_rotate | default('30') }}
    compress
    delaycompress
    notifempty
    create 644 {{ webserver_type | default('nginx') }} {{ webserver_type | default('nginx') }}
    sharedscripts
    postrotate
    {% if webserver_type == 'nginx' %}
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    {% elif webserver_type == 'apache' %}
        /bin/systemctl reload httpd > /dev/null 2>&1 || true
    {% endif %}
    endscript
}
{% endfor %}
{% endif %}
