#!/bin/bash
# Health Check Script for {{ ansible_hostname }}
# Generated by Ansible on {{ ansible_date_time }}

# Configuration
WEBSERVER_TYPE="{{ webserver_type | default('nginx') }}"
WEB_PORT="{{ webserver_port | default('80') }}"
SSL_PORT="{{ webserver_ssl_port | default('443') }}"
LOG_FILE="/var/log/webserver-health-check.log"
MAX_RETRIES=3
TIMEOUT=5

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to check HTTP endpoint
check_http() {
    local url="http://localhost:${WEB_PORT}/health"
    local response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout "$TIMEOUT" "$url" 2>/dev/null)
    
    if [ "$response" = "200" ]; then
        log_message "HTTP health check passed: $url (HTTP $response)"
        return 0
    else
        log_message "HTTP health check failed: $url (HTTP $response)"
        return 1
    fi
}

# Function to check HTTPS endpoint
check_https() {
    local url="https://localhost:${SSL_PORT}/health"
    local response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout "$TIMEOUT" -k "$url" 2>/dev/null)
    
    if [ "$response" = "200" ]; then
        log_message "HTTPS health check passed: $url (HTTP $response)"
        return 0
    else
        log_message "HTTPS health check failed: $url (HTTP $response)"
        return 1
    fi
}

# Function to check webserver process
check_process() {
    local process_name="$1"
    
    if pgrep -x "$process_name" > /dev/null; then
        log_message "$process_name process is running"
        return 0
    else
        log_message "$process_name process is not running"
        return 1
    fi
}

# Function to restart webserver
restart_webserver() {
    log_message "Attempting to restart $WEBSERVER_TYPE..."
    
    if systemctl is-active --quiet "$WEBSERVER_TYPE"; then
        systemctl restart "$WEBSERVER_TYPE"
        sleep 5
    else
        systemctl start "$WEBSERVER_TYPE"
        sleep 5
    fi
    
    if systemctl is-active --quiet "$WEBSERVER_TYPE"; then
        log_message "$WEBSERVER_TYPE restarted successfully"
        return 0
    else
        log_message "Failed to restart $WEBSERVER_TYPE"
        return 1
    fi
}

# Main health check logic
main() {
    local http_check_passed=false
    local https_check_passed=false
    local process_check_passed=false
    
    # Check webserver process
    if check_process "$WEBSERVER_TYPE"; then
        process_check_passed=true
    fi
    
    # Check HTTP endpoint
    if check_http; then
        http_check_passed=true
    fi
    
    # Check HTTPS endpoint (if SSL is enabled)
    if [ "{{ webserver_ssl_enabled | default(false) }}" = "true" ]; then
        if check_https; then
            https_check_passed=true
        fi
    else
        https_check_passed=true  # Skip HTTPS check if SSL is disabled
    fi
    
    # Overall health status
    if [ "$process_check_passed" = true ] && [ "$http_check_passed" = true ] && [ "$https_check_passed" = true ]; then
        echo "OK: All health checks passed"
        log_message "Health check: ALL PASSED"
        exit 0
    else
        echo "CRITICAL: Health checks failed"
        log_message "Health check: FAILED - Process: $process_check_passed, HTTP: $http_check_passed, HTTPS: $https_check_passed"
        
        # Attempt to restart if process is not running
        if [ "$process_check_passed" = false ]; then
            restart_webserver
        fi
        
        exit 1
    fi
}

# Run main function
main "$@"
