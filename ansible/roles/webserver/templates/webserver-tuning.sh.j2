#!/bin/bash
# Web Server Performance Tuning Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Configuration
WEBSERVER_TYPE="{{ webserver_type | default('nginx') }}"
LOG_FILE="/var/log/webserver-tuning.log"
BACKUP_DIR="/etc/webserver-tuning-backups"
ENABLE_TUNING="{{ webserver_enable_tuning | default(false) }}"

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to backup configuration file
backup_config() {
    local config_file="$1"
    local backup_name="$2"
    
    if [ -f "$config_file" ]; then
        mkdir -p "$BACKUP_DIR"
        cp "$config_file" "$BACKUP_DIR/${backup_name}_$(date +%Y%m%d_%H%M%S)"
        log_message "Backed up $config_file to $BACKUP_DIR"
    fi
}

# Function to optimize system parameters
optimize_system() {
    log_message "Optimizing system parameters"
    
    # Create sysctl configuration for web server performance
    cat > /etc/sysctl.d/99-webserver-tuning.conf << EOF
# Web Server Performance Tuning
# Generated by Ansible on {{ ansible_date_time }}

# Network settings for high concurrency
net.core.somaxconn = {{ webserver_somaxconn | default('65535') }}
net.core.netdev_max_backlog = {{ webserver_netdev_max_backlog | default('5000') }}
net.ipv4.tcp_max_syn_backlog = {{ webserver_tcp_max_syn_backlog | default('65535') }}

# TCP settings
net.ipv4.tcp_fin_timeout = {{ webserver_tcp_fin_timeout | default('15') }}
net.ipv4.tcp_keepalive_time = {{ webserver_tcp_keepalive_time | default('600') }}
net.ipv4.tcp_keepalive_probes = {{ webserver_tcp_keepalive_probes | default('3') }}
net.ipv4.tcp_keepalive_intvl = {{ webserver_tcp_keepalive_intvl | default('15') }}
net.ipv4.tcp_tw_reuse = {{ webserver_tcp_tw_reuse | default('1') }}

# File descriptor limits
fs.file-max = {{ webserver_fs_file_max | default('2097152') }}

# Memory settings
vm.swappiness = {{ webserver_vm_swappiness | default('10') }}
vm.dirty_ratio = {{ webserver_vm_dirty_ratio | default('15') }}
vm.dirty_background_ratio = {{ webserver_vm_dirty_background_ratio | default('5') }}
EOF

    # Apply sysctl settings
    sysctl -p /etc/sysctl.d/99-webserver-tuning.conf
    log_message "Applied system parameter optimizations"
}

# Function to optimize Nginx
optimize_nginx() {
    log_message "Optimizing Nginx configuration"
    
    local nginx_conf="/etc/nginx/nginx.conf"
    backup_config "$nginx_conf" "nginx.conf"
    
    # Calculate optimal worker processes and connections
    local cpu_cores=$(nproc)
    local worker_processes="{{ nginx_worker_processes | default(cpu_cores) }}"
    local worker_connections="{{ nginx_worker_connections | default('4096') }}"
    
    # Create optimized nginx configuration
    cat > "$nginx_conf" << EOF
# Optimized Nginx Configuration
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}

user nginx;
worker_processes $worker_processes;
worker_rlimit_nofile {{ nginx_worker_rlimit_nofile | default('65535') }};
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections $worker_connections;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging format
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                    '\$status \$body_bytes_sent "\$http_referer" '
                    '"\$http_user_agent" "\$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Performance settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout {{ nginx_keepalive_timeout | default('65') }};
    keepalive_requests {{ nginx_keepalive_requests | default('100') }};
    types_hash_max_size 2048;
    server_tokens off;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level {{ nginx_gzip_comp_level | default('6') }};
    gzip_min_length {{ nginx_gzip_min_length | default('1000') }};
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Rate limiting
    limit_req_zone \$binary_remote_addr zone=addr:10m rate={{ nginx_rate_limit | default('10r/s') }};
    limit_conn_zone \$binary_remote_addr zone=conn_limit_per_ip:10m;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';" always;

    # File cache settings
    open_file_cache {{ nginx_open_file_cache | default('max=2000 inactive=20s') }};
    open_file_cache_valid {{ nginx_open_file_cache_valid | default('60s') }};
    open_file_cache_min_uses {{ nginx_open_file_cache_min_uses | default('2') }};
    open_file_cache_errors on;

    # Client settings
    client_body_buffer_size {{ nginx_client_body_buffer_size | default('128k') }};
    client_max_body_size {{ nginx_client_max_body_size | default('10m') }};
    client_header_buffer_size {{ nginx_client_header_buffer_size | default('1k') }};
    large_client_header_buffers {{ nginx_large_client_header_buffers | default('4 4k') }};
    client_body_timeout {{ nginx_client_body_timeout | default('12') }};
    client_header_timeout {{ nginx_client_header_timeout | default('12') }};
    send_timeout {{ nginx_send_timeout | default('10') }};

    # Include virtual host configurations
    include /etc/nginx/conf.d/*.conf;
}
EOF

    # Test and reload nginx
    nginx -t && systemctl reload nginx
    if [ $? -eq 0 ]; then
        log_message "Nginx configuration optimized and reloaded successfully"
    else
        log_message "ERROR: Nginx configuration test failed"
        return 1
    fi
}

# Function to optimize Apache
optimize_apache() {
    log_message "Optimizing Apache configuration"
    
    local apache_conf="/etc/httpd/conf/httpd.conf"
    backup_config "$apache_conf" "httpd.conf"
    
    # Calculate optimal MPM settings based on available memory
    local total_memory=$(free -m | awk 'NR==2{print $2}')
    local avg_process_size="{{ apache_avg_process_size | default('50') }}"
    local max_workers=$((total_memory / avg_process_size * 80 / 100))  # Use 80% of memory
    
    # MPM event is preferred for performance
    cat > /etc/httpd/conf.modules.d/00-mpm.conf << EOF
# Apache MPM Configuration
# Generated by Ansible for {{ ansible_hostname }}

LoadModule mpm_event_module modules/mod_mpm_event.so
# LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
# LoadModule mpm_worker_module modules/mod_mpm_worker.so

<IfModule mpm_event_module>
    ServerLimit {{ apache_event_server_limit | default('16') }}
    ThreadLimit {{ apache_event_thread_limit | default('25') }}
    ThreadsPerChild {{ apache_event_threads_per_child | default('25') }}
    MaxRequestWorkers $max_workers
    MaxConnectionsPerChild {{ apache_event_max_connections_per_child | default('10000') }}
</IfModule>
EOF

    # Optimize main Apache configuration
    sed -i 's/^KeepAlive .*/KeepAlive On/' "$apache_conf"
    sed -i 's/^MaxKeepAliveRequests .*/MaxKeepAliveRequests {{ apache_max_keepalive_requests | default('100') }}/' "$apache_conf"
    sed -i 's/^KeepAliveTimeout .*/KeepAliveTimeout {{ apache_keepalive_timeout | default('5') }}/' "$apache_conf"
    sed -i 's/^Timeout .*/Timeout {{ apache_timeout | default('30') }}/' "$apache_conf"
    
    # Enable compression and caching
    cat > /etc/httpd/conf.d/performance.conf << EOF
# Apache Performance Optimization
# Generated by Ansible for {{ ansible_hostname }}

# Enable compression
LoadModule deflate_module modules/mod_deflate.so
<Location />
    SetOutputFilter DEFLATE
    SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png)$" no-gzip
    SetEnvIfNoCase Request_URI "\.(?:exe|t?gz|zip|bz2|sit|rar)$" no-gzip
</Location>

# Enable caching
LoadModule expires_module modules/mod_expires.so
ExpiresActive On
ExpiresByType image/jpg "access plus 1 year"
ExpiresByType image/jpeg "access plus 1 year"
ExpiresByType image/gif "access plus 1 year"
ExpiresByType image/png "access plus 1 year"
ExpiresByType text/css "access plus 1 month"
ExpiresByType application/javascript "access plus 1 month"

# Security headers
LoadModule headers_module modules/mod_headers.so
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';"

# Performance settings
EnableSendfile On
FileETag None
EOF

    # Test and reload Apache
    apachectl configtest && systemctl reload httpd
    if [ $? -eq 0 ]; then
        log_message "Apache configuration optimized and reloaded successfully"
    else
        log_message "ERROR: Apache configuration test failed"
        return 1
    fi
}

# Function to optimize file limits
optimize_file_limits() {
    log_message "Optimizing file descriptor limits"
    
    # Create limits configuration for web server
    cat > /etc/security/limits.d/99-webserver.conf << EOF
# Web Server File Limits
# Generated by Ansible for {{ ansible_hostname }}

{{ webserver_type | default('nginx') }} soft nofile {{ webserver_soft_nofile | default('65535') }}
{{ webserver_type | default('nginx') }} hard nofile {{ webserver_hard_nofile | default('65535') }}
{{ webserver_type | default('nginx') }} soft nproc {{ webserver_soft_nproc | default('32768') }}
{{ webserver_type | default('nginx') }} hard nproc {{ webserver_hard_nproc | default('32768') }}
EOF

    # Update systemd service file limits if applicable
    if [ -f "/etc/systemd/system/${WEBSERVER_TYPE}.service" ] || [ -f "/usr/lib/systemd/system/${WEBSERVER_TYPE}.service" ]; then
        mkdir -p /etc/systemd/system/${WEBSERVER_TYPE}.service.d
        cat > /etc/systemd/system/${WEBSERVER_TYPE}.service.d/limits.conf << EOF
[Service]
LimitNOFILE={{ webserver_hard_nofile | default('65535') }}
LimitNPROC={{ webserver_hard_nproc | default('32768') }}
EOF
        systemctl daemon-reload
    fi
}

# Function to clean up old log files
cleanup_logs() {
    log_message "Cleaning up old log files"
    
    # Clean up old web server logs
    find /var/log/nginx -name "*.log.*" -mtime +30 -delete 2>/dev/null || true
    find /var/log/httpd -name "*_log.*" -mtime +30 -delete 2>/dev/null || true
    
    # Clean up old tuning logs
    find "$LOG_FILE" -mtime +7 -delete 2>/dev/null || true
    
    log_message "Log cleanup completed"
}

# Function to generate performance report
generate_report() {
    log_message "Generating performance report"
    
    local report_file="/var/log/webserver-performance-report.txt"
    
    cat > "$report_file" << EOF
Web Server Performance Report
Generated: $(date)
Server: {{ ansible_hostname }}
Web Server Type: $WEBSERVER_TYPE

System Information:
- CPU Cores: $(nproc)
- Total Memory: $(free -h | grep Mem | awk '{print $2}')
- Disk Usage: $(df -h / | tail -1 | awk '{print $5}')

Web Server Status:
- Process Status: $(systemctl is-active $WEBSERVER_TYPE)
- Uptime: $(systemctl show $WEBSERVER_TYPE --property=ActiveEnterTimestamp | cut -d= -f2)
- Memory Usage: $(ps aux | grep $WEBSERVER_TYPE | grep -v grep | awk '{sum+=$6} END {print sum/1024 " MB"}')

Recent Errors:
$(tail -20 /var/log/$WEBSERVER_TYPE/*.log 2>/dev/null | grep -i error || echo "No recent errors found")

Performance Metrics:
$(tail -10 /var/log/webserver-metrics.log 2>/dev/null || echo "No metrics available")
EOF

    log_message "Performance report generated: $report_file"
}

# Main tuning function
main() {
    if [ "$ENABLE_TUNING" != "true" ]; then
        log_message "Web server tuning is disabled"
        return 0
    fi
    
    log_message "Starting web server performance tuning"
    
    # Create log directory
    mkdir -p "$(dirname "$LOG_FILE")"
    
    # Run optimizations
    optimize_system || return 1
    optimize_file_limits || return 1
    
    case "$WEBSERVER_TYPE" in
        nginx)
            optimize_nginx || return 1
            ;;
        apache|httpd)
            optimize_apache || return 1
            ;;
        *)
            log_message "ERROR: Unsupported web server type: $WEBSERVER_TYPE"
            return 1
            ;;
    esac
    
    cleanup_logs
    generate_report
    
    log_message "Web server performance tuning completed successfully"
    return 0
}

# Run main function
main "$@"
