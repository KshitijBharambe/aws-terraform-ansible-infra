# SSL Configuration for Apache
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# SSL Engine Configuration
SSLEngine on
SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder on

# SSL Certificate Configuration
SSLCertificateFile {{ apache_ssl_certificate | default('/etc/ssl/certs/apache.crt') }}
SSLCertificateKeyFile {{ apache_ssl_certificate_key | default('/etc/ssl/private/apache.key') }}

# SSL Certificate Chain (if applicable)
{% if apache_ssl_certificate_chain | default('') %}
SSLCertificateChainFile {{ apache_ssl_certificate_chain }}
{% endif %}

# SSL CA Certificate (if client authentication is enabled)
{% if apache_ssl_client_auth | default(false) %}
SSLCACertificateFile {{ apache_ssl_client_ca | default('/etc/ssl/certs/ca.crt') }}
SSLVerifyClient {{ apache_ssl_verify_client | default('optional') }}
SSLVerifyDepth {{ apache_ssl_verify_depth | default('1') }}
{% endif %}

# SSL Session Configuration
SSLSessionCache shmcb:/var/run/ssl_scache(512000)
SSLSessionCacheTimeout {{ apache_ssl_session_timeout | default('300') }}
SSLSessionTickets off

# SSL Security Headers
Header always set Strict-Transport-Security "max-age={{ apache_hsts_max_age | default('31536000') }}; includeSubDomains{% if apache_hsts_preload | default(false) %}; preload{% endif %}"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Content-Security-Policy "{{ apache_csp_policy | default('default-src \'self\'; script-src \'self\' \'unsafe-inline\'; object-src \'none\';') }}"

# SSL OCSP Stapling
SSLUseStapling on
SSLStaplingResponderTimeout {{ apache_ssl_ocsp_timeout | default('5') }}
SSLStaplingReturnResponderErrors off
SSLStaplingCache shmcb:/var/run/ocsp(128000)

# SSL Compression (disabled for security)
SSLCompression off

# SSL Perfect Forward Secrecy
SSLOptions +StdEnvVars +ExportCertData

# SSL Logging
SSLLogLevel {{ apache_ssl_log_level | default('warn') }}

# SSL Renegotiation
SSLInsecureRenegotiation off

# SSL Proxy Configuration (if needed)
{% if apache_ssl_proxy_enabled | default(false) %}
SSLProxyEngine on
SSLProxyVerify none
SSLProxyCheckPeerExpire off
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
{% endif %}

# SSL Error Pages
ErrorDocument 404 /ssl-error.html
ErrorDocument 500 /ssl-error.html
ErrorDocument 502 /ssl-error.html
ErrorDocument 503 /ssl-error.html

# SSL Timing and Performance
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin

# SSL Mutex (for Apache < 2.4)
{% if apache_version_major | default('2') | int < 4 %}
SSLMutex default
{% endif %}
