#!/bin/bash
# Configuration Backup Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Load configuration
source /etc/backup/backup-config.sh

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to send email notification
send_notification() {
    local subject="$1"
    local message="$2"
    
    if [ "$EMAIL_ENABLED" = "true" ]; then
        echo "$message" | mail -s "$subject" -r "$EMAIL_FROM" "$EMAIL_TO"
        log_message "Notification sent: $subject"
    fi
}

# Function to create backup directory
create_backup_dir() {
    local backup_path="$1"
    mkdir -p "$backup_path"
    chmod 750 "$backup_path"
    chown $BACKUP_USER:$BACKUP_GROUP "$backup_path"
}

# Function to backup configuration directories
backup_config_dirs() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="config_backup_${timestamp}"
    local backup_file="${CONFIG_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting configuration backup: $backup_name"
    
    create_backup_dir "$CONFIG_BACKUP_DIR"
    
    local temp_dir="${CONFIG_BACKUP_DIR}/${backup_name}"
    mkdir -p "$temp_dir"
    
    local found_configs=false
    
    # Backup configuration from specified directories
    for config_dir in "${CONFIG_DIRS[@]}"; do
        if [ -d "$config_dir" ]; then
            log_message "Processing configuration directory: $config_dir"
            
            # Create directory structure in backup
            local dest_dir="$temp_dir$(echo "$config_dir" | sed 's/\//_/g')"
            mkdir -p "$dest_dir"
            
            # Copy configuration files
            find "$config_dir" -type f \( -name "*.conf" -o -name "*.cfg" -o -name "*.config" -o -name "*.ini" -o -name "*.yaml" -o -name "*.yml" -o -name "*.json" \) -exec cp {} "$dest_dir/" \;
            
            # Check if any configs were copied
            if [ "$(ls -A "$dest_dir" 2>/dev/null)" ]; then
                found_configs=true
                log_message "Configuration files copied from: $config_dir"
            else
                rmdir "$dest_dir" 2>/dev/null
            fi
        else
            log_message "Configuration directory not found: $config_dir"
        fi
    done
    
    if [ "$found_configs" = true ]; then
        # Create archive
        tar -czf "$backup_file" -C "$CONFIG_BACKUP_DIR" "$backup_name"
        rm -rf "$temp_dir"
        
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        
        log_message "Configuration backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "No configuration files found for backup"
        rm -rf "$temp_dir"
        return 1
    fi
}

# Function to backup web server configurations
backup_webserver_config() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="webserver_config_${timestamp}"
    local backup_file="${CONFIG_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting web server configuration backup: $backup_name"
    
    local temp_dir="${CONFIG_BACKUP_DIR}/${backup_name}"
    mkdir -p "$temp_dir"
    
    local found_configs=false
    
    # Nginx configuration
    if [ -d "/etc/nginx" ]; then
        mkdir -p "$temp_dir/nginx"
        cp -r /etc/nginx/* "$temp_dir/nginx/" 2>/dev/null
        if [ $? -eq 0 ]; then
            found_configs=true
            log_message "Nginx configuration backed up"
        fi
    fi
    
    # Apache configuration
    if [ -d "/etc/httpd" ] || [ -d "/etc/apache2" ]; then
        if [ -d "/etc/httpd" ]; then
            mkdir -p "$temp_dir/httpd"
            cp -r /etc/httpd/* "$temp_dir/httpd/" 2>/dev/null
        else
            mkdir -p "$temp_dir/apache2"
            cp -r /etc/apache2/* "$temp_dir/apache2/" 2>/dev/null
        fi
        found_configs=true
        log_message "Apache configuration backed up"
    fi
    
    # SSL certificates
    if [ -d "/etc/ssl" ] || [ -d "/etc/pki" ]; then
        mkdir -p "$temp_dir/ssl"
        [ -d "/etc/ssl" ] && cp -r /etc/ssl/* "$temp_dir/ssl/" 2>/dev/null
        [ -d "/etc/pki" ] && cp -r /etc/pki/* "$temp_dir/ssl/" 2>/dev/null
        found_configs=true
        log_message "SSL certificates backed up"
    fi
    
    if [ "$found_configs" = true ]; then
        tar -czf "$backup_file" -C "$CONFIG_BACKUP_DIR" "$backup_name"
        rm -rf "$temp_dir"
        
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        
        log_message "Web server configuration backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "No web server configurations found"
        rm -rf "$temp_dir"
        return 1
    fi
}

# Function to backup security configurations
backup_security_config() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="security_config_${timestamp}"
    local backup_file="${CONFIG_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting security configuration backup: $backup_name"
    
    local temp_dir="${CONFIG_BACKUP_DIR}/${backup_name}"
    mkdir -p "$temp_dir"
    
    local found_configs=false
    
    # Firewall configurations
    if [ -f "/etc/iptables/rules.v4" ]; then
        mkdir -p "$temp_dir/iptables"
        cp /etc/iptables/rules.v4 "$temp_dir/iptables/" 2>/dev/null
        cp /etc/iptables/rules.v6 "$temp_dir/iptables/" 2>/dev/null
        found_configs=true
        log_message "iptables rules backed up"
    fi
    
    if [ -f "/etc/ufw/user.rules" ]; then
        mkdir -p "$temp_dir/ufw"
        cp /etc/ufw/user.rules "$temp_dir/ufw/" 2>/dev/null
        cp /etc/ufw/sysctl.conf "$temp_dir/ufw/" 2>/dev/null
        found_configs=true
        log_message "UFW rules backed up"
    fi
    
    # Fail2ban configuration
    if [ -d "/etc/fail2ban" ]; then
        mkdir -p "$temp_dir/fail2ban"
        cp -r /etc/fail2ban/* "$temp_dir/fail2ban/" 2>/dev/null
        found_configs=true
        log_message "Fail2ban configuration backed up"
    fi
    
    # SSH configuration
    if [ -f "/etc/ssh/sshd_config" ]; then
        mkdir -p "$temp_dir/ssh"
        cp /etc/ssh/sshd_config "$temp_dir/ssh/" 2>/dev/null
        found_configs=true
        log_message "SSH configuration backed up"
    fi
    
    # SELinux configuration (if enabled)
    if command -v getenforce >/dev/null 2>&1; then
        getenforce > "$temp_dir/selinux_status.txt" 2>/dev/null
        if [ -d "/etc/selinux" ]; then
            mkdir -p "$temp_dir/selinux"
            cp -r /etc/selinux/* "$temp_dir/selinux/" 2>/dev/null
        fi
        found_configs=true
        log_message "SELinux configuration backed up"
    fi
    
    if [ "$found_configs" = true ]; then
        tar -czf "$backup_file" -C "$CONFIG_BACKUP_DIR" "$backup_name"
        rm -rf "$temp_dir"
        
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        
        log_message "Security configuration backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "No security configurations found"
        rm -rf "$temp_dir"
        return 1
    fi
}

# Function to encrypt backup
encrypt_backup() {
    local file="$1"
    
    if [ "$ENCRYPTION" = "true" ] && [ -f "$KEY_FILE" ]; then
        local encrypted_file="${file}.enc"
        openssl enc -aes-256-cbc -salt -in "$file" -out "$encrypted_file" -pass file:"$KEY_FILE"
        
        if [ $? -eq 0 ]; then
            rm "$file"
            log_message "Configuration backup encrypted: $encrypted_file"
            echo "$encrypted_file"
            return 0
        else
            log_message "ERROR: Failed to encrypt configuration backup: $file"
            return 1
        fi
    fi
    
    echo "$file"
}

# Function to upload to S3
upload_to_s3() {
    local file="$1"
    
    if [ "$S3_ENABLED" = "true" ] && [ -n "$S3_BUCKET" ]; then
        local s3_path="s3://${S3_BUCKET}/config/$(basename "$file")"
        
        if [ -n "$S3_ENDPOINT" ]; then
            aws --endpoint-url "$S3_ENDPOINT" s3 cp "$file" "$s3_path" --storage-class "$S3_STORAGE_CLASS"
        else
            aws s3 cp "$file" "$s3_path" --storage-class "$S3_STORAGE_CLASS"
        fi
        
        if [ $? -eq 0 ]; then
            log_message "Configuration backup uploaded to S3: $s3_path"
            return 0
        else
            log_message "ERROR: Failed to upload configuration backup to S3: $s3_path"
            return 1
        fi
    fi
    
    return 0
}

# Main backup function
main() {
    local backup_files=()
    local start_time=$(date +%s)
    local backup_type="${1:-all}"
    
    log_message "Starting ${backup_type} configuration backup on {{ ansible_hostname }}"
    
    # Check if configuration backup is enabled
    if [ "$CONFIG_BACKUP_ENABLED" != "true" ]; then
        log_message "Configuration backup is disabled"
        return 0
    fi
    
    # Create backup directories
    create_backup_dir "$CONFIG_BACKUP_DIR"
    
    # Run backups based on type
    case "$backup_type" in
        all)
            local general_config=$(backup_config_dirs)
            if [ $? -eq 0 ] && [ -n "$general_config" ]; then
                backup_files+=("$general_config")
            fi
            
            local webserver_config=$(backup_webserver_config)
            if [ $? -eq 0 ] && [ -n "$webserver_config" ]; then
                backup_files+=("$webserver_config")
            fi
            
            local security_config=$(backup_security_config)
            if [ $? -eq 0 ] && [ -n "$security_config" ]; then
                backup_files+=("$security_config")
            fi
            ;;
        webserver)
            local webserver_config=$(backup_webserver_config)
            if [ $? -eq 0 ] && [ -n "$webserver_config" ]; then
                backup_files+=("$webserver_config")
            fi
            ;;
        security)
            local security_config=$(backup_security_config)
            if [ $? -eq 0 ] && [ -n "$security_config" ]; then
                backup_files+=("$security_config")
            fi
            ;;
        *)
            local general_config=$(backup_config_dirs)
            if [ $? -eq 0 ] && [ -n "$general_config" ]; then
                backup_files+=("$general_config")
            fi
            ;;
    esac
    
    # Process backup files
    local successful_uploads=0
    local failed_uploads=0
    
    for backup_file in "${backup_files[@]}"; do
        # Encrypt backup
        local processed_file=$(encrypt_backup "$backup_file")
        if [ $? -eq 0 ]; then
            # Upload to S3
            if upload_to_s3 "$processed_file"; then
                ((successful_uploads++))
            else
                ((failed_uploads++))
            fi
        else
            ((failed_uploads++))
        fi
    done
    
    # Calculate duration
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local duration_min=$((duration / 60))
    local duration_sec=$((duration % 60))
    
    # Send notification
    local subject="Configuration Backup Report - {{ ansible_hostname }}"
    local message="Configuration ${backup_type} backup completed in ${duration_min}m ${duration_sec}s
Successful uploads: $successful_uploads
Failed uploads: $failed_uploads
Total files processed: ${#backup_files[@]}
Server: {{ ansible_hostname }}"
    
    send_notification "$subject" "$message"
    
    log_message "Configuration backup completed in ${duration_min}m ${duration_sec}s"
    
    return 0
}

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

# Run main function
main "$@"
