#!/bin/bash
# Application Backup Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Load configuration
source /etc/backup/backup-config.sh

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to send email notification
send_notification() {
    local subject="$1"
    local message="$2"
    
    if [ "$EMAIL_ENABLED" = "true" ]; then
        echo "$message" | mail -s "$subject" -r "$EMAIL_FROM" "$EMAIL_TO"
        log_message "Notification sent: $subject"
    fi
}

# Function to create backup directory
create_backup_dir() {
    local backup_path="$1"
    mkdir -p "$backup_path"
    chmod 750 "$backup_path"
    chown $BACKUP_USER:$BACKUP_GROUP "$backup_path"
}

# Function to backup application files
backup_application() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="application_backup_${timestamp}"
    local backup_file="${APP_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting application backup: $backup_name"
    
    create_backup_dir "$APP_BACKUP_DIR"
    
    if [ ! -d "$APP_DIR" ]; then
        log_message "ERROR: Application directory not found: $APP_DIR"
        return 1
    fi
    
    # Build exclusion arguments
    local exclude_args=""
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        exclude_args="$exclude_args --exclude=$pattern"
    done
    
    # Create application backup
    tar -czf "$backup_file" \
        $exclude_args \
        -C "$(dirname "$APP_DIR")" \
        "$(basename "$APP_DIR")"
    
    if [ $? -eq 0 ]; then
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        log_message "Application backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "ERROR: Failed to create application backup"
        rm -f "$backup_file"
        return 1
    fi
}

# Function to backup user uploads
backup_uploads() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="uploads_backup_${timestamp}"
    local backup_file="${APP_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting uploads backup: $backup_name"
    
    local uploads_dir="${APP_DIR}/uploads"
    if [ -d "$uploads_dir" ]; then
        tar -czf "$backup_file" -C "$uploads_dir" .
        
        if [ $? -eq 0 ]; then
            chmod 640 "$backup_file"
            chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
            log_message "Uploads backup completed: $backup_file"
            echo "$backup_file"
            return 0
        else
            log_message "ERROR: Failed to create uploads backup"
            rm -f "$backup_file"
            return 1
        fi
    else
        log_message "No uploads directory found: $uploads_dir"
        return 1
    fi
}

# Function to backup application configuration
backup_app_config() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="app_config_backup_${timestamp}"
    local backup_file="${APP_BACKUP_DIR}/${backup_name}.tar.gz"
    
    log_message "Starting application configuration backup: $backup_name"
    
    local temp_dir="${APP_BACKUP_DIR}/${backup_name}"
    mkdir -p "$temp_dir"
    
    # Backup configuration files
    local config_files=(
        "${APP_DIR}/config"
        "${APP_DIR}/.env"
        "${APP_DIR}/config.php"
        "${APP_DIR}/settings.py"
        "${APP_DIR}/application.yml"
        "${APP_DIR}/docker-compose.yml"
    )
    
    local found_config=false
    
    for config_file in "${config_files[@]}"; do
        if [ -e "$config_file" ]; then
            cp -a "$config_file" "$temp_dir/" 2>/dev/null
            if [ $? -eq 0 ]; then
                found_config=true
                log_message "Configuration file backed up: $config_file"
            fi
        fi
    done
    
    if [ "$found_config" = true ]; then
        tar -czf "$backup_file" -C "$APP_BACKUP_DIR" "$backup_name"
        rm -rf "$temp_dir"
        
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        
        log_message "Application configuration backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "No application configuration files found"
        rm -rf "$temp_dir"
        return 1
    fi
}

# Function to create incremental backup
backup_incremental() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_name="incremental_backup_${timestamp}"
    local backup_file="${APP_BACKUP_DIR}/${backup_name}.tar.gz"
    local snapshot_file="${APP_BACKUP_DIR}/last_backup.snar"
    
    log_message "Starting incremental backup: $backup_name"
    
    if [ ! -f "$snapshot_file" ]; then
        log_message "No snapshot file found, creating full backup instead"
        return 1
    fi
    
    # Create incremental backup using snapshot
    tar --listed-incremental="$snapshot_file" \
        -czf "$backup_file" \
        -C "$(dirname "$APP_DIR")" \
        "$(basename "$APP_DIR")"
    
    if [ $? -eq 0 ]; then
        chmod 640 "$backup_file"
        chown $BACKUP_USER:$BACKUP_GROUP "$backup_file"
        log_message "Incremental backup completed: $backup_file"
        echo "$backup_file"
        return 0
    else
        log_message "ERROR: Failed to create incremental backup"
        rm -f "$backup_file"
        return 1
    fi
}

# Function to encrypt backup
encrypt_backup() {
    local file="$1"
    
    if [ "$ENCRYPTION" = "true" ] && [ -f "$KEY_FILE" ]; then
        local encrypted_file="${file}.enc"
        openssl enc -aes-256-cbc -salt -in "$file" -out "$encrypted_file" -pass file:"$KEY_FILE"
        
        if [ $? -eq 0 ]; then
            rm "$file"
            log_message "Application backup encrypted: $encrypted_file"
            echo "$encrypted_file"
            return 0
        else
            log_message "ERROR: Failed to encrypt application backup: $file"
            return 1
        fi
    fi
    
    echo "$file"
}

# Function to upload to S3
upload_to_s3() {
    local file="$1"
    
    if [ "$S3_ENABLED" = "true" ] && [ -n "$S3_BUCKET" ]; then
        local s3_path="s3://${S3_BUCKET}/application/$(basename "$file")"
        
        if [ -n "$S3_ENDPOINT" ]; then
            aws --endpoint-url "$S3_ENDPOINT" s3 cp "$file" "$s3_path" --storage-class "$S3_STORAGE_CLASS"
        else
            aws s3 cp "$file" "$s3_path" --storage-class "$S3_STORAGE_CLASS"
        fi
        
        if [ $? -eq 0 ]; then
            log_message "Application backup uploaded to S3: $s3_path"
            return 0
        else
            log_message "ERROR: Failed to upload application backup to S3: $s3_path"
            return 1
        fi
    fi
    
    return 0
}

# Function to create snapshot file
create_snapshot() {
    local snapshot_file="${APP_BACKUP_DIR}/last_backup.snar"
    tar --listed-incremental="$snapshot_file" -cf /dev/null -C "$(dirname "$APP_DIR")" "$(basename "$APP_DIR")" 2>/dev/null
}

# Main backup function
main() {
    local backup_files=()
    local start_time=$(date +%s)
    local backup_type="${1:-full}"
    
    log_message "Starting ${backup_type} application backup on {{ ansible_hostname }}"
    
    # Check if application backup is enabled
    if [ "$APP_BACKUP_ENABLED" != "true" ]; then
        log_message "Application backup is disabled"
        return 0
    fi
    
    # Create backup directories
    create_backup_dir "$APP_BACKUP_DIR"
    
    # Run backups based on type
    case "$backup_type" in
        full)
            local app_backup=$(backup_application)
            if [ $? -eq 0 ] && [ -n "$app_backup" ]; then
                backup_files+=("$app_backup")
            fi
            
            local uploads_backup=$(backup_uploads)
            if [ $? -eq 0 ] && [ -n "$uploads_backup" ]; then
                backup_files+=("$uploads_backup")
            fi
            
            local config_backup=$(backup_app_config)
            if [ $? -eq 0 ] && [ -n "$config_backup" ]; then
                backup_files+=("$config_backup")
            fi
            
            # Create snapshot for next incremental backup
            create_snapshot
            ;;
        incremental)
            local inc_backup=$(backup_incremental)
            if [ $? -eq 0 ] && [ -n "$inc_backup" ]; then
                backup_files+=("$inc_backup")
            fi
            ;;
        config)
            local config_backup=$(backup_app_config)
            if [ $? -eq 0 ] && [ -n "$config_backup" ]; then
                backup_files+=("$config_backup")
            fi
            ;;
        *)
            log_message "ERROR: Unknown backup type: $backup_type"
            return 1
            ;;
    esac
    
    # Process backup files
    local successful_uploads=0
    local failed_uploads=0
    
    for backup_file in "${backup_files[@]}"; do
        # Encrypt backup
        local processed_file=$(encrypt_backup "$backup_file")
        if [ $? -eq 0 ]; then
            # Upload to S3
            if upload_to_s3 "$processed_file"; then
                ((successful_uploads++))
            else
                ((failed_uploads++))
            fi
        else
            ((failed_uploads++))
        fi
    done
    
    # Calculate duration
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local duration_min=$((duration / 60))
    local duration_sec=$((duration % 60))
    
    # Send notification
    local subject="Application Backup Report - {{ ansible_hostname }}"
    local message="Application ${backup_type} backup completed in ${duration_min}m ${duration_sec}s
Successful uploads: $successful_uploads
Failed uploads: $failed_uploads
Total files processed: ${#backup_files[@]}
Server: {{ ansible_hostname }}"
    
    send_notification "$subject" "$message"
    
    log_message "Application backup completed in ${duration_min}m ${duration_sec}s"
    
    return 0
}

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

# Run main function
main "$@"
