#!/bin/bash
# Backup Report Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Load configuration
source /etc/backup/backup-config.sh

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to send email notification
send_notification() {
    local subject="$1"
    local message="$2"
    
    if [ "$EMAIL_ENABLED" = "true" ]; then
        echo "$message" | mail -s "$subject" -r "$EMAIL_FROM" "$EMAIL_TO"
        log_message "Notification sent: $subject"
    fi
}

# Function to generate backup statistics
generate_backup_statistics() {
    local report_type="$1"
    local days_back="${2:-7}"  # Default to last 7 days
    
    log_message "Generating backup statistics for last $days_back days"
    
    local total_backups=0
    local successful_backups=0
    local failed_backups=0
    local total_size=0
    local backup_types=()
    local backup_sizes=()
    
    # Analyze backup files
    while IFS= read -r -d '' backup_file; do
        if [ -f "$backup_file" ]; then
            local file_size=$(stat -c%s "$backup_file" 2>/dev/null || stat -f%z "$backup_file" 2>/dev/null)
            ((total_backups++))
            ((total_size += file_size))
            
            # Determine backup type
            local backup_type="unknown"
            case "$backup_file" in
                *system*) backup_type="system" ;;
                *database*) backup_type="database" ;;
                *application*) backup_type="application" ;;
                *log*) backup_type="log" ;;
                *config*) backup_type="config" ;;
            esac
            
            backup_types+=("$backup_type")
            backup_sizes+=("$file_size")
            
            # Check if backup appears successful (based on log analysis)
            if [[ "$backup_file" != *.failed ]]; then
                ((successful_backups++))
            else
                ((failed_backups++))
            fi
        fi
    done < <(find "$BACKUP_DIR" -name "*.tar.gz" -o -name "*.sql.gz" -o -name "*.enc" -mtime -${days_back} -print0 2>/dev/null)
    
    # Calculate statistics
    local success_rate=0
    if [ $total_backups -gt 0 ]; then
        success_rate=$((successful_backups * 100 / total_backups))
    fi
    
    local avg_size=0
    if [ $total_backups -gt 0 ]; then
        avg_size=$((total_size / total_backups))
    fi
    
    # Return statistics as variables
    echo "TOTAL_BACKUPS=$total_backups"
    echo "SUCCESSFUL_BACKUPS=$successful_backups"
    echo "FAILED_BACKUPS=$failed_backups"
    echo "SUCCESS_RATE=$success_rate"
    echo "TOTAL_SIZE=$total_size"
    echo "AVG_SIZE=$avg_size"
}

# Function to analyze backup performance
analyze_backup_performance() {
    local days_back="${1:-7}"
    
    log_message "Analyzing backup performance for last $days_back days"
    
    local performance_data=()
    
    # Extract performance data from logs
    if [ -f "$LOG_FILE" ]; then
        while IFS= read -r line; do
            if echo "$line" | grep -q "completed in"; then
                local duration=$(echo "$line" | grep -o "[0-9]*m [0-9]*s" | sed 's/m/*s/ /' | sed 's/ //')
                local timestamp=$(echo "$line" | grep -o '\[.*\]' | sed 's/\[//g')
                performance_data+=("$timestamp:$duration")
            fi
        done < <(find "$LOG_FILE" -mtime -${days_back} -exec grep "completed in" {} \; 2>/dev/null)
    fi
    
    if [ ${#performance_data[@]} -gt 0 ]; then
        echo "PERFORMANCE_SAMPLES=${#performance_data[@]}"
        
        # Calculate average duration
        local total_duration=0
        for data in "${performance_data[@]}"; do
            local duration=$(echo "$data" | cut -d: -f2)
            # Convert duration to seconds (simplified calculation)
            local minutes=$(echo "$duration" | cut -dm -f1)
            local seconds=$(echo "$duration" | cut -dm -f2)
            total_duration=$((total_duration + minutes * 60 + seconds))
        done
        
        local avg_duration=$((total_duration / ${#performance_data[@]}))
        local avg_minutes=$((avg_duration / 60))
        local avg_seconds=$((avg_duration % 60))
        
        echo "AVG_DURATION=${avg_minutes}m${avg_seconds}s"
    else
        echo "PERFORMANCE_SAMPLES=0"
        echo "AVG_DURATION=Unknown"
    fi
}

# Function to analyze storage usage
analyze_storage_usage() {
    log_message "Analyzing storage usage"
    
    local backup_dirs=(
        "$BACKUP_DIR"
        "$SYSTEM_BACKUP_DIR"
        "$DB_BACKUP_DIR"
        "$APP_BACKUP_DIR"
        "$LOG_BACKUP_DIR"
        "$CONFIG_BACKUP_DIR"
    )
    
    for dir in "${backup_dirs[@]}"; do
        if [ -d "$dir" ]; then
            local usage=$(df "$dir" | tail -1 | awk '{print $5}' | sed 's/%//')
            local available=$(df -h "$dir" | tail -1 | awk '{print $4}')
            local total=$(df -h "$dir" | tail -1 | awk '{print $2}')
            local used=$(df -h "$dir" | tail -1 | awk '{print $3}')
            
            local dir_name=$(basename "$dir")
            echo "${dir_name}_USAGE=$usage"
            echo "${dir_name}_AVAILABLE=$available"
            echo "${dir_name}_TOTAL=$total"
            echo "${dir_name}_USED=$used"
        fi
    done
}

# Function to analyze S3 usage
analyze_s3_usage() {
    if [ -z "$S3_BUCKET" ]; then
        log_message "S3 not configured, skipping S3 usage analysis"
        return
    fi
    
    log_message "Analyzing S3 usage for bucket: $S3_BUCKET"
    
    # Get S3 bucket size and object count
    local bucket_info=""
    if [ -n "$S3_ENDPOINT" ]; then
        bucket_info=$(aws --endpoint-url "$S3_ENDPOINT" s3 ls "$S3_BUCKET" --recursive --human-readable --summarize 2>/dev/null | tail -1)
    else
        bucket_info=$(aws s3 ls "$S3_BUCKET" --recursive --human-readable --summarize 2>/dev/null | tail -1)
    fi
    
    if [ -n "$bucket_info" ]; then
        local object_count=$(echo "$bucket_info" | awk '{print $1}')
        local total_size=$(echo "$bucket_info" | awk '{print $3}')
        
        echo "S3_OBJECT_COUNT=$object_count"
        echo "S3_TOTAL_SIZE=$total_size"
    else
        echo "S3_OBJECT_COUNT=0"
        echo "S3_TOTAL_SIZE=0"
    fi
}

# Function to generate trend analysis
generate_trend_analysis() {
    local days_back="${1:-30}"
    
    log_message "Generating trend analysis for last $days_back days"
    
    local daily_backups=()
    local daily_dates=()
    
    # Collect daily backup counts
    for ((i=0; i<days_back; i++)); do
        local target_date=$(date -d "$i days ago" '+%Y-%m-%d')
        local day_backups=$(find "$BACKUP_DIR" -name "*.tar.gz" -o -name "*.sql.gz" -o -name "*.enc" -newermt "$(date -d "$i days ago" '+%Y-%m-%d 00:00:00')" ! -newermt "$(date -d "$((i-1)) days ago" '+%Y-%m-%d 00:00:00')" -print | wc -l)
        
        daily_backups+=("$day_backups")
        daily_dates+=("$target_date")
    done
    
    # Calculate trend
    local recent_avg=0
    local older_avg=0
    
    # Recent period (last 7 days)
    for ((i=0; i<7 && i<${#daily_backups[@]}; i++)); do
        recent_avg=$((recent_avg + daily_backups[i]))
    done
    
    if [ 7 -lt ${#daily_backups[@]} ]; then
        recent_avg=$((recent_avg / 7))
    fi
    
    # Older period (days 8-30)
    local older_days=$((${#daily_backups[@]} - 7))
    if [ $older_days -gt 0 ]; then
        for ((i=7; i<${#daily_backups[@]}; i++)); do
            older_avg=$((older_avg + daily_backups[i]))
        done
        older_avg=$((older_avg / older_days))
    fi
    
    local trend="stable"
    if [ $recent_avg -gt $((older_avg + 2)) ]; then
        trend="increasing"
    elif [ $recent_avg -lt $((older_avg - 2)) ]; then
        trend="decreasing"
    fi
    
    echo "RECENT_AVG=$recent_avg"
    echo "OLDER_AVG=$older_avg"
    echo "TREND=$trend"
}

# Function to generate comprehensive report
generate_comprehensive_report() {
    local report_type="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Generate all statistics
    eval "$(generate_backup_statistics "$report_type")"
    eval "$(analyze_backup_performance)"
    eval "$(analyze_storage_usage)"
    eval "$(analyze_s3_usage)"
    eval "$(generate_trend_analysis)"
    
    # Create HTML report
    local html_file="/tmp/backup_report_$$$.html"
    
    cat > "$html_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Backup Report - {{ ansible_hostname }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 30px; }
        .section h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db; }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; }
        .metric-label { font-weight: bold; color: #555; }
        .metric-value { color: #333; }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .chart { text-align: center; margin: 20px 0; }
        .footer { text-align: center; margin-top: 30px; color: #777; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Backup System Report</h1>
            <h2>{{ ansible_hostname }}</h2>
            <p>Generated: $timestamp</p>
            <p>Report Type: $report_type</p>
        </div>

        <div class="section">
            <h2>ðŸ“Š Backup Statistics</h2>
            <div class="grid">
                <div class="card">
                    <div class="metric">
                        <span class="metric-label">Total Backups:</span>
                        <span class="metric-value">$TOTAL_BACKUPS</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Successful:</span>
                        <span class="metric-value status-good">$SUCCESSFUL_BACKUPS</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Failed:</span>
                        <span class="metric-value $([ $FAILED_BACKUPS -gt 0 ] && echo 'status-danger' || echo 'status-good')">$FAILED_BACKUPS</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Success Rate:</span>
                        <span class="metric-value $([ $SUCCESS_RATE -lt 95 ] && echo 'status-warning' || echo 'status-good')">$SUCCESS_RATE%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>âš¡ Performance Metrics</h2>
            <div class="grid">
                <div class="card">
                    <div class="metric">
                        <span class="metric-label">Average Duration:</span>
                        <span class="metric-value">$AVG_DURATION</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Performance Samples:</span>
                        <span class="metric-value">$PERFORMANCE_SAMPLES</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Average Backup Size:</span>
                        <span class="metric-value">$(numfmt --to=iec-i --suffix=B $AVG_SIZE)</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Storage Used:</span>
                        <span class="metric-value">$(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ðŸ’¾ Storage Usage</h2>
            <div class="grid">
EOF

    # Add storage cards
    local backup_dirs=("BACKUP_DIR" "SYSTEM_BACKUP_DIR" "DB_BACKUP_DIR" "APP_BACKUP_DIR")
    local dir_names=("Main Backup" "System Backup" "Database Backup" "Application Backup")
    
    for i in "${!backup_dirs[@]}"; do
        local var_name="${backup_dirs[i]}_USAGE"
        local usage="${!var_name:-0}"
        local var_available="${backup_dirs[i]}_AVAILABLE"
        local available="${!var_available:-0}"
        
        local status_class="status-good"
        if [ "$usage" -gt 85 ]; then
            status_class="status-danger"
        elif [ "$usage" -gt 70 ]; then
            status_class="status-warning"
        fi
        
        cat >> "$html_file" << EOF
                <div class="card">
                    <div class="metric">
                        <span class="metric-label">${dir_names[i]}:</span>
                        <span class="metric-value $status_class">${usage}% (${available} free)</span>
                    </div>
                </div>
EOF
    done

    # Add S3 usage if configured
    if [ -n "$S3_BUCKET" ]; then
        cat >> "$html_file" << EOF
                <div class="card">
                    <div class="metric">
                        <span class="metric-label">S3 Objects:</span>
                        <span class="metric-value">$S3_OBJECT_COUNT</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">S3 Storage:</span>
                        <span class="metric-value">$S3_TOTAL_SIZE</span>
                    </div>
                </div>
EOF
    fi

    cat >> "$html_file" << EOF
            </div>
        </div>

        <div class="section">
            <h2>ðŸ“ˆ Trend Analysis</h2>
            <div class="card">
                <div class="metric">
                    <span class="metric-label">Recent Average (7 days):</span>
                    <span class="metric-value">$RECENT_AVG backups/day</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Older Average:</span>
                    <span class="metric-value">$OLDER_AVG backups/day</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Trend:</span>
                    <span class="metric-value">
EOF

    case "$TREND" in
        increasing)
            echo "<span class='status-warning'>ðŸ“ˆ Increasing</span>" >> "$html_file"
            ;;
        decreasing)
            echo "<span class='status-danger'>ðŸ“‰ Decreasing</span>" >> "$html_file"
            ;;
        *)
            echo "<span class='status-good'>ðŸ“Š Stable</span>" >> "$html_file"
            ;;
    esac

    cat >> "$html_file" << EOF
                    </span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ðŸ”§ System Information</h2>
            <table>
                <tr><th>Property</th><th>Value</th></tr>
                <tr><td>Hostname</td><td>{{ ansible_hostname }}</td></tr>
                <tr><td>OS</td><td>{{ ansible_distribution }} {{ ansible_distribution_version }}</td></tr>
                <tr><td>Uptime</td><td>$(uptime -p 2>/dev/null | head -1 || uptime)</td></tr>
                <tr><td>Load Average</td><td>$(uptime | awk -F'load average:' '{print $2}' | sed 's/^ *//')</td></tr>
                <tr><td>Memory Usage</td><td>$(free -h | grep Mem | awk '{print $3 "/" $2}' | sed 's/^ *//')</td></tr>
                <tr><td>Disk Usage</td><td>$(df -h "$BACKUP_DIR" | tail -1 | awk '{print $5 " (" $4 " free)"}')</td></tr>
            </table>
        </div>

        <div class="footer">
            <p>Report generated by Backup Monitoring System on {{ ansible_hostname }}</p>
            <p>For questions or issues, contact: {{ backup_email_to | default('admin@' + ansible_domain) }}</p>
        </div>
    </div>
</body>
</html>
EOF

    echo "$html_file"
}

# Main report function
main() {
    local report_type="${1:-comprehensive}"
    local output_format="${2:-html}"
    local send_email="${3:-true}"
    
    log_message "Generating $report_type backup report on {{ ansible_hostname }}"
    
    case "$report_type" in
        comprehensive|daily|weekly|monthly)
            local report_file=$(generate_comprehensive_report "$report_type")
            
            if [ "$output_format" = "text" ]; then
                # Convert to text format
                lynx -dump "$report_file" > "${report_file%.html}.txt" 2>/dev/null || \
                w3m -dump "$report_file" > "${report_file%.html}.txt" 2>/dev/null || \
                echo "Text format conversion not available. HTML report saved: $report_file"
            fi
            
            # Send email if requested
            if [ "$send_email" = "true" ]; then
                local subject="Backup Report - {{ ansible_hostname }} ($report_type)"
                local body="Backup $report_type report for {{ ansible_hostname }} is attached."
                
                if command -v mutt >/dev/null 2>&1; then
                    mutt -s "$subject" -a "$report_file" -- "$EMAIL_TO" <<< "$body"
                else
                    # Send as text email if mutt not available
                    if [ -f "${report_file%.html}.txt" ]; then
                        cat "${report_file%.html}.txt" | mail -s "$subject" -a "$report_file" -r "$EMAIL_FROM" "$EMAIL_TO"
                    else
                        echo "$body" | mail -s "$subject" -a "$report_file" -r "$EMAIL_FROM" "$EMAIL_TO"
                    fi
                fi
                
                log_message "Backup report sent via email"
            fi
            
            log_message "Backup report generated: $report_file"
            ;;
        *)
            log_message "ERROR: Unknown report type: $report_type"
            echo "Usage: $0 [comprehensive|daily|weekly|monthly] [html|text] [true|false]"
            exit 1
            ;;
    esac
}

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

# Run main function
main "$@"
