#!/bin/bash
# Backup Cleanup Script
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Load configuration
source /etc/backup/backup-config.sh

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to send email notification
send_notification() {
    local subject="$1"
    local message="$2"
    
    if [ "$EMAIL_ENABLED" = "true" ]; then
        echo "$message" | mail -s "$subject" -r "$EMAIL_FROM" "$EMAIL_TO"
        log_message "Notification sent: $subject"
    fi
}

# Function to cleanup old backups
cleanup_old_backups() {
    local backup_dir="$1"
    local retention_days="$2"
    local backup_type="$3"
    
    log_message "Cleaning up old $backup_type backups in $backup_dir (older than $retention_days days)"
    
    if [ ! -d "$backup_dir" ]; then
        log_message "Backup directory not found: $backup_dir"
        return 0
    fi
    
    local deleted_count=0
    local freed_space=0
    
    # Find and delete old backup files
    while IFS= read -r -d '' backup_file; do
        if [ -f "$backup_file" ]; then
            local file_size=$(stat -c%s "$backup_file" 2>/dev/null || stat -f%z "$backup_file" 2>/dev/null)
            
            # Remove file
            rm -f "$backup_file"
            
            if [ $? -eq 0 ]; then
                ((deleted_count++))
                ((freed_space += file_size))
                log_message "Deleted old backup: $backup_file ($(numfmt --to=iec-i --suffix=B $file_size))"
            else
                log_message "ERROR: Failed to delete backup: $backup_file"
            fi
        fi
    done < <(find "$backup_dir" -type f -mtime +$retention_days -print0 2>/dev/null)
    
    # Convert bytes to human readable
    local freed_space_human=$(numfmt --to=iec-i --suffix=B $freed_space)
    
    log_message "Cleanup completed for $backup_type: $deleted_count files deleted, $freed_space_human freed"
    
    return $deleted_count
}

# Function to cleanup S3 backups
cleanup_s3_backups() {
    local s3_prefix="$1"
    local retention_days="$2"
    
    log_message "Cleaning up old S3 backups in $s3_prefix (older than $retention_days days)"
    
    if [ -z "$S3_BUCKET" ]; then
        log_message "WARNING: S3 cleanup skipped (S3 not configured)"
        return 0
    fi
    
    local deleted_count=0
    local cutoff_date=$(date -d "$retention_days days ago" '+%Y-%m-%d')
    
    # List S3 objects and delete old ones
    local s3_files=$(aws s3 ls "s3://$S3_BUCKET/$s3_prefix" --recursive 2>/dev/null | awk '{print $4}')
    
    for s3_file in $s3_files; do
        # Extract date from filename (assuming YYYY-MM-DD format in filename)
        local file_date=$(echo "$s3_file" | grep -o '[0-9]\{8\}' | head -1)
        
        if [ -n "$file_date" ]; then
            local formatted_date=$(date -d "${file_date:0:4}-${file_date:4:2}-${file_date:6:2}" '+%Y-%m-%d' 2>/dev/null)
            
            if [ -n "$formatted_date" ] && [ "$formatted_date" \< "$cutoff_date" ]; then
                # Get file size before deletion
                local file_size=$(aws s3api head-object --bucket "$S3_BUCKET" --key "$s3_file" --query 'ContentLength' --output text 2>/dev/null)
                
                # Delete from S3
                aws s3 rm "s3://$S3_BUCKET/$s3_file" 2>/dev/null
                
                if [ $? -eq 0 ]; then
                    ((deleted_count++))
                    log_message "Deleted old S3 backup: $s3_file ($(numfmt --to=iec-i --suffix=B $file_size))"
                else
                    log_message "ERROR: Failed to delete S3 backup: $s3_file"
                fi
            fi
        fi
    done
    
    log_message "S3 cleanup completed: $deleted_count files deleted"
    
    return $deleted_count
}

# Function to cleanup temporary files
cleanup_temp_files() {
    log_message "Cleaning up temporary files"
    
    local temp_dirs=(
        "/tmp/backup_*"
        "/tmp/db_verify_*"
        "/tmp/sample_verify_*"
        "/tmp/backup_verification_report_*"
        "/var/tmp/backup_*"
    )
    
    local deleted_count=0
    
    for temp_pattern in "${temp_dirs[@]}"; do
        while IFS= read -r -d '' temp_item; do
            if [ -e "$temp_item" ]; then
                rm -rf "$temp_item"
                if [ $? -eq 0 ]; then
                    ((deleted_count++))
                    log_message "Deleted temporary item: $temp_item"
                else
                    log_message "ERROR: Failed to delete temporary item: $temp_item"
                fi
            fi
        done < <(find /tmp /var/tmp -name "$(basename "$temp_pattern")" -print0 2>/dev/null)
    done
    
    log_message "Temporary files cleanup completed: $deleted_count items deleted"
    
    return $deleted_count
}

# Function to cleanup log files
cleanup_log_files() {
    local log_retention_days="${1:-7}"
    
    log_message "Cleaning up old log files (older than $log_retention_days days)"
    
    local log_dirs=(
        "$LOG_FILE"
        "/var/log/backup*.log"
        "/var/log/webserver-backup*.log"
        "/var/log/backup-monitor*.log"
    )
    
    local deleted_count=0
    
    for log_pattern in "${log_dirs[@]}"; do
        while IFS= read -r -d '' log_file; do
            if [ -f "$log_file" ]; then
                local file_size=$(stat -c%s "$log_file" 2>/dev/null || stat -f%z "$log_file" 2>/dev/null)
                
                rm -f "$log_file"
                
                if [ $? -eq 0 ]; then
                    ((deleted_count++))
                    log_message "Deleted old log file: $log_file ($(numfmt --to=iec-i --suffix=B $file_size))"
                else
                    log_message "ERROR: Failed to delete log file: $log_file"
                fi
            fi
        done < <(find $(dirname "$log_pattern") -name "$(basename "$log_pattern")" -type f -mtime +$log_retention_days -print0 2>/dev/null)
    done
    
    log_message "Log files cleanup completed: $deleted_count files deleted"
    
    return $deleted_count
}

# Function to generate cleanup report
generate_cleanup_report() {
    local total_deleted=$1
    local total_freed=$2
    local cleanup_type="$3"
    
    local freed_space_human=$(numfmt --to=iec-i --suffix=B $total_freed)
    
    cat << EOF
Backup Cleanup Report
Generated: $(date '+%Y-%m-%d %H:%M:%S')
Server: {{ ansible_hostname }}
Cleanup Type: $cleanup_type

Summary:
Total Files Deleted: $total_deleted
Total Space Freed: $freed_space_human

Cleanup Actions:
- Local backup files older than retention period
- S3 backup objects older than retention period
- Temporary files from backup operations
- Old log files

Recommendations:
- Monitor disk space usage regularly
- Review backup retention policies
- Consider implementing automated cleanup schedules
- Verify backup importance before extending retention periods
EOF
}

# Function to check disk space
check_disk_space() {
    local backup_path="$1"
    local threshold="${2:-90}"  # Default 90% threshold
    
    if [ ! -d "$backup_path" ]; then
        return 0
    fi
    
    local disk_usage=$(df "$backup_path" | tail -1 | awk '{print $5}' | sed 's/%//')
    local available_space=$(df -h "$backup_path" | tail -1 | awk '{print $4}')
    
    if [ "$disk_usage" -gt "$threshold" ]; then
        log_message "WARNING: Disk usage high ($disk_usage%) on $(df "$backup_path" | tail -1 | awk '{print $1}'), only ${available_space} available"
        return 1
    else
        log_message "Disk usage OK ($disk_usage%) on $(df "$backup_path" | tail -1 | awk '{print $1}'), ${available_space} available"
        return 0
    fi
}

# Main cleanup function
main() {
    local cleanup_type="${1:-all}"
    local total_deleted=0
    local total_freed=0
    local start_time=$(date +%s)
    
    log_message "Starting backup cleanup: $cleanup_type on {{ ansible_hostname }}"
    
    # Check if cleanup is enabled
    if [ "$CLEANUP_ENABLED" != "true" ]; then
        log_message "Backup cleanup is disabled"
        return 0
    fi
    
    # Check disk space before cleanup
    check_disk_space "$BACKUP_DIR"
    check_disk_space "$DB_BACKUP_DIR"
    check_disk_space "$APP_BACKUP_DIR"
    check_disk_space "$LOG_BACKUP_DIR"
    check_disk_space "$CONFIG_BACKUP_DIR"
    
    case "$cleanup_type" in
        local)
            # Cleanup local backups only
            log_message "Starting local backup cleanup"
            
            local system_deleted=$(cleanup_old_backups "$SYSTEM_BACKUP_DIR" $RETENTION_DAYS "system")
            local db_deleted=$(cleanup_old_backups "$DB_BACKUP_DIR" $RETENTION_DAYS "database")
            local app_deleted=$(cleanup_old_backups "$APP_BACKUP_DIR" $RETENTION_DAYS "application")
            local log_deleted=$(cleanup_old_backups "$LOG_BACKUP_DIR" $RETENTION_DAYS "log")
            local config_deleted=$(cleanup_old_backups "$CONFIG_BACKUP_DIR" $RETENTION_DAYS "config")
            
            total_deleted=$((system_deleted + db_deleted + app_deleted + log_deleted + config_deleted))
            ;;
        s3)
            # Cleanup S3 backups only
            log_message "Starting S3 backup cleanup"
            
            local s3_system_deleted=$(cleanup_s3_backups "system/" $RETENTION_DAYS)
            local s3_db_deleted=$(cleanup_s3_backups "database/" $RETENTION_DAYS)
            local s3_app_deleted=$(cleanup_s3_backups "application/" $RETENTION_DAYS)
            local s3_log_deleted=$(cleanup_s3_backups "logs/" $RETENTION_DAYS)
            local s3_config_deleted=$(cleanup_s3_backups "config/" $RETENTION_DAYS)
            
            total_deleted=$((s3_system_deleted + s3_db_deleted + s3_app_deleted + s3_log_deleted + s3_config_deleted))
            ;;
        temp)
            # Cleanup temporary files only
            log_message "Starting temporary files cleanup"
            
            total_deleted=$(cleanup_temp_files)
            ;;
        logs)
            # Cleanup log files only
            log_message "Starting log files cleanup"
            
            total_deleted=$(cleanup_log_files)
            ;;
        *)
            # Cleanup everything
            log_message "Starting full cleanup"
            
            # Local cleanup
            local system_deleted=$(cleanup_old_backups "$SYSTEM_BACKUP_DIR" $RETENTION_DAYS "system")
            local db_deleted=$(cleanup_old_backups "$DB_BACKUP_DIR" $RETENTION_DAYS "database")
            local app_deleted=$(cleanup_old_backups "$APP_BACKUP_DIR" $RETENTION_DAYS "application")
            local log_deleted=$(cleanup_old_backups "$LOG_BACKUP_DIR" $RETENTION_DAYS "log")
            local config_deleted=$(cleanup_old_backups "$CONFIG_BACKUP_DIR" $RETENTION_DAYS "config")
            
            # S3 cleanup
            local s3_system_deleted=$(cleanup_s3_backups "system/" $RETENTION_DAYS)
            local s3_db_deleted=$(cleanup_s3_backups "database/" $RETENTION_DAYS)
            local s3_app_deleted=$(cleanup_s3_backups "application/" $RETENTION_DAYS)
            local s3_log_deleted=$(cleanup_s3_backups "logs/" $RETENTION_DAYS)
            local s3_config_deleted=$(cleanup_s3_backups "config/" $RETENTION_DAYS)
            
            # Temp files and logs cleanup
            local temp_deleted=$(cleanup_temp_files)
            local log_files_deleted=$(cleanup_log_files)
            
            total_deleted=$((system_deleted + db_deleted + app_deleted + log_deleted + config_deleted + s3_system_deleted + s3_db_deleted + s3_app_deleted + s3_log_deleted + s3_config_deleted + temp_deleted + log_files_deleted))
            ;;
    esac
    
    # Calculate space freed (approximation based on retention and typical backup sizes)
    total_freed=$((total_deleted * 100 * 1024 * 1024))  # Rough estimate
    
    # Calculate duration
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local duration_min=$((duration / 60))
    local duration_sec=$((duration % 60))
    
    # Generate and send report
    local report=$(generate_cleanup_report "$total_deleted" "$total_freed" "$cleanup_type")
    
    log_message "Backup cleanup completed in ${duration_min}m ${duration_sec}s - $total_deleted files deleted"
    
    # Check disk space after cleanup
    check_disk_space "$BACKUP_DIR"
    
    # Send notification
    local subject="Backup Cleanup Report - {{ ansible_hostname }}"
    local message="Backup cleanup completed on {{ ansible_hostname }}
Type: $cleanup_type
Duration: ${duration_min}m ${duration_sec}s
Files Deleted: $total_deleted
Space Freed: $(numfmt --to=iec-i --suffix=B $total_freed)

$report"
    
    send_notification "$subject" "$message"
    
    return 0
}

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

# Run main function
main "$@"
