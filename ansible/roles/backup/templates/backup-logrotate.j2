# Logrotate configuration for backup logs
# Generated by Ansible for {{ ansible_hostname }}
# Environment: {{ ansible_environment }}
# Generated: {{ ansible_date_time }}

# Backup logs rotation
{{ backup_log_file | default('/var/log/backup.log') }} {
    daily
    missingok
    rotate {{ backup_log_rotate_days | default('14') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    sharedscripts
    postrotate
        # Send rotation notification if enabled
        {% if backup_email_on_rotation | default('true') %}
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Log rotation completed for {{ ansible_hostname }}" >> {{ backup_log_file | default('/var/log/backup.log') }}
        tail -20 "{{ backup_log_file | default('/var/log/backup.log') }}" | mail -s "Backup Log Rotation - {{ ansible_hostname }}" -r {{ backup_email_from | default('backup@' + ansible_domain) }} {{ backup_email_to | default('admin@' + ansible_domain) }} 2>/dev/null || true
        {% endif %}
    endscript
}

# Application backup logs rotation
{{ backup_app_log_dir | default('/var/log/backup-app.log') }} {
    daily
    missingok
    rotate {{ backup_app_log_rotate_days | default('30') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_app_log_max_size | default('100M') }}
    sharedscripts
    postrotate
        # Restart backup monitoring if applicable
        systemctl reload backup-monitor 2>/dev/null || true
    endscript
}

# Database backup logs rotation
{{ backup_db_log_dir | default('/var/log/backup-db.log') }} {
    daily
    missingok
    rotate {{ backup_db_log_rotate_days | default('30') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_db_log_max_size | default('100M') }}
    sharedscripts
    postrotate
        # Send database backup rotation summary
        find {{ backup_db_backup_dir | default('/opt/backups/database') }} -name "*.sql.gz" -mtime -1 -exec basename {} \; | mail -s "Database Backup Rotation Summary - {{ ansible_hostname }}" -r {{ backup_email_from | default('backup@' + ansible_domain) }} {{ backup_email_to | default('admin@' + ansible_domain) }} 2>/dev/null || true
    endscript
}

# System backup logs rotation
{{ backup_system_log_dir | default('/var/log/backup-system.log') }} {
    weekly
    missingok
    rotate {{ backup_system_log_rotate_days | default('8') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_system_log_max_size | default('50M') }}
    sharedscripts
    postrotate
        # Archive old system backup logs to S3 if configured
        {% if backup_s3_enabled | default('false') %}
        for rotated_file in $(ls -t {{ backup_system_log_dir | default('/var/log/backup-system.log') }}.*.gz 2>/dev/null | head -3); do
            aws s3 cp "$rotated_file" "s3://{{ backup_s3_bucket | default('') }}/logs/system-$(basename $rotated_file)" 2>/dev/null || true
        done
        {% endif %}
    endscript
}

# Web server backup logs rotation
{{ backup_webserver_log_dir | default('/var/log/backup-webserver.log') }} {
    daily
    missingok
    rotate {{ backup_webserver_log_rotate_days | default('14') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    sharedscripts
    postrotate
        # Restart web server monitoring
        systemctl reload webserver-monitor 2>/dev/null || true
    endscript
}

# Cleanup logs rotation
{{ backup_cleanup_log_dir | default('/var/log/backup-cleanup.log') }} {
    weekly
    missingok
    rotate {{ backup_cleanup_log_rotate_days | default('4') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_cleanup_log_max_size | default('10M') }}
}

# S3 backup logs rotation
{% if backup_s3_enabled | default('false') %}
{{ backup_s3_log_dir | default('/var/log/backup-s3.log') }} {
    daily
    missingok
    rotate {{ backup_s3_log_rotate_days | default('7') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_s3_log_max_size | default('50M') }}
    sharedscripts
    postrotate
        # Sync S3 access logs to centralized logging
        {% if backup_s3_log_sync | default('false') %}
        aws s3 sync {{ backup_s3_log_dir | default('/var/log/backup-s3.log') }}/ "s3://{{ backup_s3_log_bucket | default('') }}/backup-logs/" --delete --exclude "*" --include "*.gz" 2>/dev/null || true
        {% endif %}
    endscript
}
{% endif %}

# Verification logs rotation
{{ backup_verify_log_dir | default('/var/log/backup-verify.log') }} {
    daily
    missingok
    rotate {{ backup_verify_log_rotate_days | default('7') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_verify_log_max_size | default('20M') }}
    sharedscripts
    postrotate
        # Generate verification summary report
        tail -50 "{{ backup_verify_log_dir | default('/var/log/backup-verify.log') }}" | grep -E "(PASSED|FAILED|ERROR)" | sort | uniq -c > /tmp/verification_summary_$$
        cat /tmp/verification_summary_$$ | mail -s "Backup Verification Summary - {{ ansible_hostname }}" -r {{ backup_email_from | default('backup@' + ansible_domain) }} {{ backup_email_to | default('admin@' + ansible_domain) }} 2>/dev/null || true
        rm -f /tmp/verification_summary_$$
    endscript
}

# Monitoring logs rotation
{{ backup_monitor_log_dir | default('/var/log/backup-monitor.log') }} {
    hourly
    missingok
    rotate {{ backup_monitor_log_rotate_days | default('24') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_monitor_log_max_size | default('200M') }}
    sharedscripts
    postrotate
        # Check for critical errors in the last hour
        if find {{ backup_monitor_log_dir | default('/var/log/backup-monitor.log') }} -mmin -60 -exec grep -l "CRITICAL\|ERROR" {} \; then
            tail -20 "{{ backup_monitor_log_dir | default('/var/log/backup-monitor.log') }}" | mail -s "CRITICAL: Backup Monitor Alert - {{ ansible_hostname }}" -r {{ backup_email_from | default('backup@' + ansible_domain) }} {{ backup_email_to | default('admin@' + ansible_domain) }} 2>/dev/null || true
        fi
    endscript
}

# Performance metrics logs rotation
{% if backup_metrics_enabled | default('true') %}
{{ backup_metrics_log_dir | default('/var/log/backup-metrics.log') }} {
    daily
    missingok
    rotate {{ backup_metrics_log_rotate_days | default('14') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_metrics_log_max_size | default('10M') }}
    sharedscripts
    postrotate
        # Generate daily performance report
        /usr/local/bin/backup-report.sh --daily 2>/dev/null || true
    endscript
}
{% endif %}

# Error logs rotation (with immediate compression)
{{ backup_error_log_dir | default('/var/log/backup-error.log') }} {
    daily
    missingok
    rotate {{ backup_error_log_rotate_days | default('30') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_error_log_max_size | default('100M') }}
    sharedscripts
    postrotate
        # Immediate alert on error log rotation (indicates many errors)
        tail -10 "{{ backup_error_log_dir | default('/var/log/backup-error.log') }}" | mail -s "ALERT: Backup Error Log Rotation - {{ ansible_hostname }}" -r {{ backup_email_from | default('backup@' + ansible_domain) }} {{ backup_email_to | default('admin@' + ansible_domain) }} 2>/dev/null || true
    endscript
}

# Audit logs rotation (longer retention)
{{ backup_audit_log_dir | default('/var/log/backup-audit.log') }} {
    monthly
    missingok
    rotate {{ backup_audit_log_rotate_days | default('12') }}
    compress
    delaycompress
    notifempty
    create 640 {{ backup_user | default('backup') }} {{ backup_group | default('backup') }}
    size {{ backup_audit_log_max_size | default('50M') }}
    sharedscripts
    postrotate
        # Archive audit logs to secure storage
        {% if backup_audit_archive | default('true') %}
        for archived_log in $(ls -t {{ backup_audit_log_dir | default('/var/log/backup-audit.log') }}.*.gz 2>/dev/null); do
            mv "$archived_log" "{{ backup_audit_archive_dir | default('/var/log/backup-archive') }}/"
        done
        {% endif %}
    endscript
}

# Custom backup logs rotation (for application-specific logs)
{% for custom_log in backup_custom_logs | default([]) %}
{{ custom_log.path }} {
    daily
    missingok
    rotate {{ custom_log.rotate_days | default('7') }}
    compress
    delaycompress
    notifempty
    create 640 {{ custom_log.owner | default('backup') }} {{ custom_log.group | default('backup') }}
    size {{ custom_log.max_size | default('50M') }}
    sharedscripts
    postrotate
        {% if custom_log.post_command | default('') %}
        {{ custom_log.post_command }}
        {% endif %}
    endscript
}
{% endfor %}
