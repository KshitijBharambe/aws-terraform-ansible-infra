---
# Security hardening role - main tasks

- name: Include SSH hardening tasks
  include_tasks: ssh.yml
  tags: security,ssh

- name: Include firewall configuration tasks
  include_tasks: firewall.yml
  tags: security,firewall

- name: Include fail2ban setup tasks
  include_tasks: fail2ban.yml
  tags: security,fail2ban
  when: security_fail2ban_enabled | default(true)

- name: Include audit logging tasks
  include_tasks: auditd.yml
  tags: security,audit
  when: ansible_os_family == "Debian"

- name: Disable unused services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - telnet
    - rsh
    - rlogin
  ignore_errors: yes
  when: ansible_os_family == "Debian"

- name: Remove unused packages
  apt:
    name: "{{ item }}"
    state: absent
    autoremove: yes
    purge: yes
  loop:
    - telnetd
    - rsh-server
    - rsh-client
    - talk
  when: ansible_os_family == "Debian"

- name: Configure automatic security updates
  apt:
    name: unattended-upgrades
    state: present
  when: ansible_os_family == "Debian"

- name: Configure unattended-upgrades
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  notify: Restart unattended-upgrades
  when: ansible_os_family == "Debian"

- name: Enable automatic updates
  template:
    src: auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"
  notify: Restart unattended-upgrades
  when: ansible_os_family == "Debian"

- name: Configure password policies
  lineinfile:
    path: /etc/pam.d/common-password
    regexp: "^password.*pam_unix.so"
    line: "password [success=1 default=ignore] pam_unix.so sha512 shadow nullok try_first_pass use_authtok minlen=12 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1"
    state: present
  when: ansible_os_family == "Debian"

- name: Configure file permissions for sensitive files
  file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
  loop:
    - { path: /etc/passwd, mode: "0644" }
    - { path: /etc/shadow, mode: "0640" }
    - { path: /etc/group, mode: "0644" }
    - { path: /etc/gshadow, mode: "0640" }
    - { path: /etc/ssh/sshd_config, mode: "0600" }

- name: Install and configure AIDE (Advanced Intrusion Detection Environment)
  apt:
    name: aide
    state: present
  when: security_enable_aide | default(false)

- name: Initialize AIDE database
  command: aide --init
  args:
    creates: /var/lib/aide/aide.db.new
  when: security_enable_aide | default(false)

- name: Move AIDE database to active location
  command: mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
  when: security_enable_aide | default(false)

- name: Configure log rotation for security logs
  template:
    src: security-logrotate.j2
    dest: /etc/logrotate.d/security
    owner: root
    group: root
    mode: "0644"
  when: ansible_os_family == "Debian"

- name: Disable USB storage if required
  lineinfile:
    path: /etc/modprobe.d/blacklist.conf
    line: "blacklist usb_storage"
    state: present
    create: yes
  when: security_disable_usb | default(false)

- name: Set system-wide file permissions
  file:
    path: "{{ item }}"
    mode: "{{ item.mode }}"
    recurse: yes
  loop:
    - { path: /root, mode: "0700" }
    - { path: /home, mode: "0755" }
  when: ansible_os_family == "Debian"
